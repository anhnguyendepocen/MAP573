<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>R for Statistics</title>
  <meta name="description" content="R for Statistics">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="R for Statistics" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="R for Statistics" />
  
  
  

<meta name="author" content="Julie Josse">


<meta name="date" content="2017-09-30">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="homework-pca.html">
<link rel="next" href="shiny-app.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R for Statistics</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Syllabus</a></li>
<li class="chapter" data-level="2" data-path="what-is-r.html"><a href="what-is-r.html"><i class="fa fa-check"></i><b>2</b> What is R?</a></li>
<li class="chapter" data-level="3" data-path="getting-started-with-r.html"><a href="getting-started-with-r.html"><i class="fa fa-check"></i><b>3</b> Getting Started with R</a></li>
<li class="chapter" data-level="4" data-path="reproducible.html"><a href="reproducible.html"><i class="fa fa-check"></i><b>4</b> Reproducible research</a></li>
<li class="chapter" data-level="5" data-path="graphics.html"><a href="graphics.html"><i class="fa fa-check"></i><b>5</b> Graphics</a></li>
<li class="chapter" data-level="6" data-path="homework-exploratory-analysis.html"><a href="homework-exploratory-analysis.html"><i class="fa fa-check"></i><b>6</b> Homework: exploratory analysis</a></li>
<li class="chapter" data-level="7" data-path="tests.html"><a href="tests.html"><i class="fa fa-check"></i><b>7</b> Tests</a></li>
<li class="chapter" data-level="8" data-path="homework-tests.html"><a href="homework-tests.html"><i class="fa fa-check"></i><b>8</b> Homework: tests</a></li>
<li class="chapter" data-level="9" data-path="principal-components-analysis.html"><a href="principal-components-analysis.html"><i class="fa fa-check"></i><b>9</b> Principal components analysis</a></li>
<li class="chapter" data-level="10" data-path="homework-pca.html"><a href="homework-pca.html"><i class="fa fa-check"></i><b>10</b> Homework: PCA</a></li>
<li class="chapter" data-level="11" data-path="handling-missing-values.html"><a href="handling-missing-values.html"><i class="fa fa-check"></i><b>11</b> Handling missing values</a><ul>
<li class="chapter" data-level="11.1" data-path="handling-missing-values.html"><a href="handling-missing-values.html#lecture"><i class="fa fa-check"></i><b>11.1</b> Lecture</a></li>
<li class="chapter" data-level="11.2" data-path="handling-missing-values.html"><a href="handling-missing-values.html#lab"><i class="fa fa-check"></i><b>11.2</b> Lab</a><ul>
<li class="chapter" data-level="11.2.1" data-path="handling-missing-values.html"><a href="handling-missing-values.html#lecture-questions"><i class="fa fa-check"></i><b>11.2.1</b> Lecture questions</a></li>
<li class="chapter" data-level="11.2.2" data-path="handling-missing-values.html"><a href="handling-missing-values.html#continuous-data-with-missing-values---regression-with-missing-data-via-multiple-imputation"><i class="fa fa-check"></i><b>11.2.2</b> Continuous data with missing values - Regression with missing data via Multiple Imputation</a></li>
<li class="chapter" data-level="11.2.3" data-path="handling-missing-values.html"><a href="handling-missing-values.html#em-algorithm-for-bivariate-normal-data-with-missing-values"><i class="fa fa-check"></i><b>11.2.3</b> EM algorithm for bivariate normal data with missing values</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="shiny-app.html"><a href="shiny-app.html"><i class="fa fa-check"></i><b>12</b> Shiny App</a></li>
<li class="chapter" data-level="13" data-path="ref.html"><a href="ref.html"><i class="fa fa-check"></i><b>13</b> References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R for Statistics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="handling-missing-values" class="section level1">
<h1><span class="header-section-number">Chapter 11</span> Handling missing values</h1>
<div id="lecture" class="section level2">
<h2><span class="header-section-number">11.1</span> Lecture</h2>
</div>
<div id="lab" class="section level2">
<h2><span class="header-section-number">11.2</span> Lab</h2>
<div id="lecture-questions" class="section level3">
<h3><span class="header-section-number">11.2.1</span> Lecture questions</h3>
<ul>
<li><p>When you suggest methods to deal with missing values to users, the recurrent question is “What is the percentage of missing values that I can have in my data set, is 50% too much but 20% OK?” What is your answer to this question?</p></li>
<li><p>Explain the aims of multiple imputation in comparison to single imputation.</p></li>
</ul>
</div>
<div id="continuous-data-with-missing-values---regression-with-missing-data-via-multiple-imputation" class="section level3">
<h3><span class="header-section-number">11.2.2</span> Continuous data with missing values - Regression with missing data via Multiple Imputation</h3>
<p>First of all you will need to install the following packages</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;VIM&quot;</span>)
<span class="kw">install.packages</span>(<span class="st">&quot;missMDA&quot;</span>)
<span class="kw">install.packages</span>(<span class="st">&quot;Amelia&quot;</span>)</code></pre></div>
<p>Air pollution is currently one of the most serious public health worries worldwide. Many epidemiological studies have proved the influence that some chemical compounds, such as sulphur dioxide (SO2), nitrogen dioxide (NO2), ozone (O3) can have on our health. Associations set up to monitor air quality are active all over the world to measure the concentration of these pollutants. They also keep a record of meteorological conditions such as temperature, cloud cover, wind, etc.</p>
<p>We have at our disposal 112 observations collected during the summer of 2001 in Rennes. The variables available are</p>
<ul>
<li>maxO3 (maximum daily ozone)</li>
<li>maxO3v (maximum daily ozone the previous day)</li>
<li>T12 (temperature at midday)</li>
<li>T9</li>
<li>T15 (Temp at 3pm)</li>
<li>Vx12 (projection of the wind speed vector on the east-west axis at midday)</li>
<li>Vx9 and Vx15 as well as the Nebulosity (cloud) Ne9, Ne12, Ne15</li>
</ul>
<p>Here the final aim is to analyse the relationship between the maximum daily ozone (maxO3) level and the other meteorological variables. To do so we will perform regression to explain maxO3 in function of all the other variables. This data is incomplete (there are missing values). Indeed, it occurs frenquently to have machines that fail one day, leading to some information not recorded. We will therefore perform regression via multiple imputation.</p>
<ul>
<li>Import the data.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ozo &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;data/ozoneNA.csv&quot;</span>,<span class="dt">header=</span><span class="ot">TRUE</span>,
<span class="dt">sep=</span><span class="st">&quot;,&quot;</span>, <span class="dt">row.names=</span><span class="dv">1</span>)
WindDirection &lt;-<span class="st"> </span>ozo[,<span class="dv">12</span>]
don &lt;-<span class="st"> </span>ozo[,<span class="dv">1</span>:<span class="dv">11</span>]   #### keep the continuous variables
<span class="kw">summary</span>(don)</code></pre></div>
<pre><code>##      maxO3              T9             T12             T15       
##  Min.   : 42.00   Min.   :11.30   Min.   :14.30   Min.   :14.90  
##  1st Qu.: 71.00   1st Qu.:16.00   1st Qu.:18.60   1st Qu.:18.90  
##  Median : 81.50   Median :17.70   Median :20.40   Median :21.40  
##  Mean   : 91.24   Mean   :18.22   Mean   :21.46   Mean   :22.41  
##  3rd Qu.:108.25   3rd Qu.:19.90   3rd Qu.:23.60   3rd Qu.:25.65  
##  Max.   :166.00   Max.   :25.30   Max.   :33.50   Max.   :35.50  
##  NA&#39;s   :16       NA&#39;s   :37      NA&#39;s   :33      NA&#39;s   :37     
##       Ne9             Ne12            Ne15           Vx9         
##  Min.   :0.000   Min.   :0.000   Min.   :0.00   Min.   :-7.8785  
##  1st Qu.:3.000   1st Qu.:4.000   1st Qu.:3.00   1st Qu.:-3.0000  
##  Median :5.000   Median :5.000   Median :5.00   Median :-0.8671  
##  Mean   :4.987   Mean   :4.986   Mean   :4.60   Mean   :-1.0958  
##  3rd Qu.:7.000   3rd Qu.:7.000   3rd Qu.:6.25   3rd Qu.: 0.6919  
##  Max.   :8.000   Max.   :8.000   Max.   :8.00   Max.   : 5.1962  
##  NA&#39;s   :34      NA&#39;s   :42      NA&#39;s   :32     NA&#39;s   :18       
##       Vx12              Vx15            maxO3v      
##  Min.   :-7.8785   Min.   :-9.000   Min.   : 42.00  
##  1st Qu.:-3.6941   1st Qu.:-3.759   1st Qu.: 70.00  
##  Median :-1.9284   Median :-1.710   Median : 82.50  
##  Mean   :-1.6853   Mean   :-1.830   Mean   : 89.39  
##  3rd Qu.:-0.1302   3rd Qu.: 0.000   3rd Qu.:101.00  
##  Max.   : 6.5778   Max.   : 3.830   Max.   :166.00  
##  NA&#39;s   :10        NA&#39;s   :21       NA&#39;s   :12</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(don)</code></pre></div>
<pre><code>##          maxO3   T9  T12  T15 Ne9 Ne12 Ne15     Vx9    Vx12    Vx15 maxO3v
## 20010601    87 15.6 18.5   NA   4    4    8  0.6946 -1.7101 -0.6946     84
## 20010602    82   NA   NA   NA   5    5    7 -4.3301 -4.0000 -3.0000     87
## 20010603    92 15.3 17.6 19.5   2   NA   NA  2.9544      NA  0.5209     82
## 20010604   114 16.2 19.7   NA   1    1    0      NA  0.3473 -0.1736     92
## 20010605    94   NA 20.5 20.4  NA   NA   NA -0.5000 -2.9544 -4.3301    114
## 20010606    80 17.7 19.8 18.3   6   NA    7 -5.6382 -5.0000 -6.0000     94</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(don)</code></pre></div>
<pre><code>## [1] 112  11</code></pre>
<ul>
<li>Load the libraries.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(VIM)
<span class="kw">library</span>(FactoMineR)</code></pre></div>
<p>First, we perfom some descriptive statistics (how many missing? how many variables, individuals with missing?) and try to <strong>inspect and vizualize the pattern of missing entries and get hints on the mechanism</strong> that generated the missingness. For this purpose, we use the R package <strong>VIM</strong> (Visualization and Imputation of Missing Values - Mathias Templ) as well as Multiple Correspondence Analysis (FactoMineR package). The package VIM provides tools for the visualization of missing or imputed values, which can be used for exploring the data and the structure of the missing or imputed values. Depending on this structure, they may help to identify the mechanism generating the missing values or errors, which may have happened in the imputation process. You should install the package VIM, then you can check the documentation by executing</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">?VIM</code></pre></div>
<p>The VIM function <strong>aggr</strong> calculates and plots the amount of missing entries in each variables and in some combinations of variables (that tend to be missing simultaneously).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(<span class="kw">na.omit</span>(don))
res&lt;-<span class="kw">summary</span>(<span class="kw">aggr</span>(don, <span class="dt">sortVar=</span><span class="ot">TRUE</span>))$combinations</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(res[<span class="kw">rev</span>(<span class="kw">order</span>(res[,<span class="dv">2</span>])),])
<span class="kw">aggr</span>(don, <span class="dt">sortVar=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>The VIM function <strong>matrixplot </strong> creates a matrix plot in which all cells of a data matrix are visualized by rectangles. Available data is coded according to a continuous color scheme (gray scale), while missing/imputed data is visualized by a clearly distinguishable color (red). If you use Rstudio the plot is not interactive (thus the warnings), but if you use R directly, you can click on a column of your choice, this will result in sorting the rows in the decreasing order of the values of this column. This is useful to check if there is an association between the value of a variable and the missingness of another one.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">matrixplot</span>(don,<span class="dt">sortby=</span><span class="dv">2</span>) <span class="co"># marche pas sur Rstudio</span></code></pre></div>
<p>The VIM function <strong>marginplot</strong> creates a scatterplot with additional information on the missing values. If you plot the variables (x,y), the points with no missing values are represented as in a standard scatterplot. The points for which x (resp. y) is missing are represented in red along the y (resp. x) axis. In addition, boxplots of the x and y variables are represented along the axes with and without missing values (in red all variables x where y is missing, in blue all variables x where y is observed).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">marginplot</span>(don[,<span class="kw">c</span>(<span class="st">&quot;T9&quot;</span>,<span class="st">&quot;maxO3&quot;</span>)])</code></pre></div>
<ul>
<li><p>Do you observe any associations between the missing entries ? When values are missing on a variable does it correspond to small or large values on another one ? (For this question you need to use the matrixplot function in R)</p></li>
<li><p>Create a categorical dataset with “o” when the value of the cell is observed and “m” when it is missing, and with the same row and column names as in the original data. Then, you can perform Multiple Correspondence Analysis to visualize the association with the <strong>MCA</strong> function.</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">?MCA</code></pre></div>
<p>Then, before modeling the data, we perform a <strong>PCA with missing values</strong> to explore the correlation between variables. Use the R package <strong>missMDA</strong> dedicated to perform principal components methods with missing values and to impute data with PC methods.</p>
<ul>
<li>Determine the number of components ncp to keep using the <strong>estim_ncpPCA</strong> function. Perform PCA with missing values using the <strong>imputePCA</strong> function and ncp components. Then plot the correlation circle.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">?estim_ncpPCA
?imputePCA</code></pre></div>
<ul>
<li>Could you guess how cross-validation is performed to select the number of components?</li>
</ul>
<p>Then, to run the regression with missing values, we use <strong>Multiple Imputation</strong>. We impute the data either assuming 1) a Gaussian distribution (library Amelia) or 2) a PCA based model (library missMDA). Note that there are two ways to impute either using a Joint Modeling (one joint probabilitisc model for the variables all together) or a Condional Modeling (one model per variable) approach. We refer to the references given in the slides for more details. We use the R package <strong>Amelia</strong>. We generate 100 imputed data sets with the amelia method:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(Amelia)</code></pre></div>
<pre><code>## Loading required package: Rcpp</code></pre>
<pre><code>## ## 
## ## Amelia II: Multiple Imputation
## ## (Version 1.7.4, built: 2015-12-05)
## ## Copyright (C) 2005-2017 James Honaker, Gary King and Matthew Blackwell
## ## Refer to http://gking.harvard.edu/amelia/ for more information
## ##</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">?amelia</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.amelia &lt;-<span class="st"> </span><span class="kw">amelia</span>(don, <span class="dt">m=</span><span class="dv">100</span>)  
<span class="co">#names(res.amelia$imputations) </span>
res.amelia$imputations$imp1<span class="co"># the first imputed data set</span></code></pre></div>
<ul>
<li>Now generate 100 imputed data sets with the MIPCA method and 2 components. Store the result in a variable called res.MIPCA.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">?MIPCA
?plot.MIPCA</code></pre></div>
<p>We will <strong>inspect the imputed values created</strong> to know if the imputation method should require more investigation or if we can continue and analyze the data. A common practice consists in comparing the distribution of the imputed values and of the observed values. Check the <strong>compare.density</strong> function and apply it to compare the distributions of the T12 variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">?compare.density</code></pre></div>
<ul>
<li>Do both distributions need to be close? Could the missing values differ from the observed ones both in spread and in location?</li>
</ul>
<p>The quality of imputation can also be assessed with cross-validation using the <strong>overimpute</strong> function. Each observed value is deleted and for each one 100 values are predicted (using the same MI method) and the mean and 90% confidence intervals are computed for these 100 values. Then, we inspect whether the observed value falls within the obtained interval. On the graph, the y=x line is plotted (where the imputations should fall if they were perfect), as well as the mean (dots) and intervals (lines) for each value. Around ninety percent of these confidence intervals should contain the y = x line, which means that the true observed value falls within this range. The color of the line (as coded in the legend) represents the fraction of missing observations in the pattern of missingness for that observation (ex: blue=0-2 missing entries).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">?overimpute</code></pre></div>
<ul>
<li>Comment the quality of the imputation.</li>
</ul>
<p>We can also examine the variability by projecting as supplementary tables the imputed data sets on the PCA configuration (plot the results of MI with PCA).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(res.MIPCA,<span class="dt">choice=</span> <span class="st">&quot;ind.supp&quot;</span>)
<span class="kw">plot</span>(res.MIPCA,<span class="dt">choice=</span> <span class="st">&quot;var&quot;</span>)</code></pre></div>
<ul>
<li>Apply a regression model on each imputed data set of the amelia method. Hint: a regression with several variables can be performed as follows ‘lm(formula=“maxO3 ~ T9+T12”, data =don)’. You can also use the function <strong>with</strong>.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">resamelia &lt;-<span class="st"> </span><span class="kw">lapply</span>(res.amelia$imputations, as.data.frame)
<span class="co"># A regression on each imputed dataset</span>
fitamelia&lt;-<span class="kw">lapply</span>(resamelia, lm, 
                  <span class="dt">formula=</span><span class="st">&quot;maxO3~ T9+T12+T15+Ne9+Ne12+Ne15+Vx9+Vx12+Vx15+maxO3v&quot;</span>)  
<span class="co"># fitamelia &lt;- lapply(resamelia, with, </span>
<span class="co">#                     lm(maxO3 ~ T9+T12+T15+Ne9+Ne12+Ne15+Vx9+Vx12+Vx15+maxO3v))</span></code></pre></div>
<ul>
<li>Now do the same with the imputed datasets of the MIPCA method.</li>
</ul>
<p>The package <strong>mice</strong> (Multiple Imputation by Chained Equations) allows to aggregate the results from some simple models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(mice)
<span class="co"># ?mice</span>
<span class="co"># pool is a function from mice to aggregate the results according to Rubin&#39;s rule</span>
<span class="co"># ?pool</span></code></pre></div>
<ul>
<li>Aggregate the results of Regression with Multiple Imputation according to Rubin’s rule (slide “Multiple imputation”) for MI with amelia with the <strong>pool</strong> function from the mice package.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">poolamelia&lt;-<span class="kw">pool</span>(<span class="kw">as.mira</span>(fitamelia)) 
<span class="kw">summary</span>(poolamelia)</code></pre></div>
<ul>
<li><p>Now do the same with the MIPCA results.</p></li>
<li><p>Write a function that removes the variables with the largest pvalues step by step (each time a variable is removed the regression model is performed again) until all variables are significant.</p></li>
</ul>
</div>
<div id="em-algorithm-for-bivariate-normal-data-with-missing-values" class="section level3">
<h3><span class="header-section-number">11.2.3</span> EM algorithm for bivariate normal data with missing values</h3>
<p>author: “Julie Josse - Nicolas Brosse - Geneviève Robin” Exam 2016</p>
<p>The purpose of this problem is to use the EM algorithm to estimate the mean of a bivariate normal dataset with missing entries in one of the two variables. We first generate synthetic data and then implement the EM algorithm to compute the estimator of the mean.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(mvtnorm)</code></pre></div>
<p>We consider a bivariate normal random variable <span class="math inline">\(y=\begin{pmatrix} y_1\\ y_2 \end{pmatrix}\)</span> and denote the mean vector and covariance matrix of its distribution <span class="math inline">\(\mu=\begin{pmatrix} \mu_1\\ \mu_2 \end{pmatrix}\)</span> and <span class="math inline">\(\Sigma=\begin{pmatrix} \sigma_{11} &amp; \sigma_{12}\\ \sigma_{12} &amp; \sigma_{22} \end{pmatrix}\)</span>: <span class="math inline">\(y\sim \mathcal{N}(\mu, \Sigma)\)</span>. We observe a sample of size <span class="math inline">\(n\)</span> that contains some missing values in the variable <span class="math inline">\(y_2\)</span>, such that for some <span class="math inline">\(r\leq n\)</span>, we observe <span class="math inline">\((y_{i1},y_{i2})\)</span> for <span class="math inline">\(i=1,..., r\)</span> and <span class="math inline">\(y_{i1}\)</span> for <span class="math inline">\(i=r+1,... n\)</span>. The goal is to estimate the mean <span class="math inline">\(\mu\)</span>. We will compare two strategies: 1) direct computation of the maximum likelihood estimator and 2) estimation of the mean with the EM algorithm.</p>
<div id="data-generation" class="section level4">
<h4><span class="header-section-number">11.2.3.1</span> Data generation</h4>
<p><strong>(R1)</strong> Generate a bivariate normal sample of size <span class="math inline">\(100\)</span> of mean <span class="math inline">\(\begin{pmatrix} \mu_1\\ \mu_2 \end{pmatrix}=\begin{pmatrix} 5\\ -1 \end{pmatrix}\)</span> and covariance matrix <span class="math inline">\(\begin{pmatrix} \sigma_{11} &amp; \sigma_{12}\\ \sigma_{12} &amp; \sigma_{22} \end{pmatrix}=\begin{pmatrix} 1.3 &amp; 0.4\\ 0.4 &amp; 0.9 \end{pmatrix}\)</span> containing 30% of missing values in the variable <span class="math inline">\(y_2\)</span>.</p>
</div>
<div id="maximum-likelihood-estimator" class="section level4">
<h4><span class="header-section-number">11.2.3.2</span> Maximum likelihood estimator</h4>
<p>We denote by <span class="math inline">\(f_{1,2}(y_1,y_2;\mu, \Sigma)\)</span>, <span class="math inline">\(f_1(y_1;\mu_1, \sigma_{11})\)</span> and <span class="math inline">\(f_{2|1}(y_2|y_1; \mu, \Sigma)\)</span> the probability density functions of the joint <span class="math inline">\((y_1,y_2)\)</span>, <span class="math inline">\(y_1\)</span> and <span class="math inline">\(y_2|y_1\)</span> respectively. The likelihood of the observed data can be written as <span class="math display">\[f_{1,2}(y_1,y_2;\mu, \Sigma)=\prod_{i=1}^nf_1(y_{i1})\prod_{j=1}^rf_{2|1}(y_{j2}|y_{j1}),\]</span> and the log-ikelihood is written (up to an additional constant that does not appear in the maximization and that we therefore drop)</p>
<p><span class="math display">\[l(\mu, \Sigma|y_1,y_2)=-\frac{n}{2}\log(\sigma_{11}^2)-\frac{1}{2}\sum_{i=1}^n\frac{(y_{i1}-\mu_1)^2}{\sigma_{11}^2}-\frac{r}{2}\log((\sigma_{22}-\frac{\sigma_{12}^2}{\sigma_{11}})^2)\]</span> <span class="math display">\[-\frac{1}{2}\sum_{i=1}^r\frac{(y_{i2}-\mu_2-\frac{\sigma_{12}}{\sigma_{11}}(y_{i1}-\mu_1))^2}{(\sigma_{22}-\frac{\sigma_{12}^2}{\sigma_{11}})^2}\]</span></p>
<p>We skip the computations and directly give the expression of the closed form maximum likelihood estimator of the mean: <span class="math display">\[  \hat{\mu}_1=n^{-1}\sum_{i=1}^ny_{i1} \]</span> <span class="math display">\[  \hat{\mu}_2=\hat{\beta}_{20.1}+\hat{\beta}_{21.1}\hat{\mu}_1,\]</span></p>
<p><span class="math inline">\(\hat{\beta}_{21.1}=s_{12}/s_{11}\)</span>, <span class="math inline">\(\hat{\beta}_{20.1}=\bar{y}_2-\hat{\beta}_{21.1}\bar{y}_1\)</span>, and <span class="math inline">\(\bar{y}_j=r^{-1}\sum_{i=1}^ry_{ij}\)</span>, <span class="math inline">\(j=1,2\)</span> and <span class="math inline">\(s_{jk}=r^{-1}\sum_{i=1}^r(y_{ij}-\bar{y}_j)(y_{ik}-\bar{y}_k)\)</span>, <span class="math inline">\(j,k=1,2\)</span></p>
<p><strong>(R2)</strong> Compute the maximum likelihood estimates of <span class="math inline">\(\mu_1\)</span> and <span class="math inline">\(\mu_2\)</span>.</p>
</div>
<div id="em-algorithm" class="section level4">
<h4><span class="header-section-number">11.2.3.3</span> EM algorithm</h4>
<p>In this simple setting, we have an explicit expression of the maximum likelihood estimator despite missing values. However, this is not always the case but it is possible to use an EM algorithm which allows to get the maximum likelihood estimators in the cases where data are missing.</p>
<p>The EM algorithm consists in maximizing the “observed likelihood” <span class="math display">\[l(\mu, \Sigma|y_1,y_2)=-\frac{n}{2}\log(\sigma_{11}^2)-\frac{1}{2}\sum_{i=1}^n\frac{(y_{i1}-\mu_1)^2}{\sigma_{11}^2}-\frac{r}{2}\log((\sigma_{22}-\frac{\sigma_{12}^2}{\sigma_{11}})^2)\]</span> <span class="math display">\[-\frac{1}{2}\sum_{i=1}^r\frac{(y_{i2}-\mu_2-\frac{\sigma_{12}}{\sigma_{11}}(y_{i1}-\mu_1))^2}{(\sigma_{22}-\frac{\sigma_{12}^2}{\sigma_{11}})^2},\]</span> through successive maximization of the “complete likelihood” (if we had observed all <span class="math inline">\(n\)</span> realizations of <span class="math inline">\(y_1\)</span> and <span class="math inline">\(y_2\)</span>). Maximizing the complete likelihood <span class="math display">\[l_c(\mu, \Sigma|y_1,y_2)=-\frac{n}{2}\log(\det(\Sigma))-\frac{1}{2}\sum_{i=1}^n(y_{i1}-\mu_1)^T\Sigma^{-1}(y_{i1}-\mu_1)\]</span></p>
<p>would be straightforward if we had all the observations. However elements of this likelihood are not available. Consequently, we replace them by the conditional expectation given observed data and the parameters of the current iteration. These two steps of computation of the conditional expectation (E-step) and maximization of the completed likelihood (M step) are repeated until convergence.</p>
<p>The update formulas for the E and M steps are the following</p>
<p><strong>E step</strong>:</p>
<p>The sufficient statistics of the likelihood are:</p>
<p><span class="math display">\[s_1=\sum_{i=1}^ny_{i1},\quad s_2=\sum_{i=1}^ny_{i2},\quad s_{11}=\sum_{i=1}^ny_{i1}^2,\quad s_{22}=\sum_{i=1}^ny_{i2}^2,\quad s_{12}=\sum_{i=1}^ny_{i1}y_{i2}.\]</span></p>
<p>Since some values of <span class="math inline">\(y_2\)</span> are not available, we fill in the sufficient statistics with:</p>
<p><span class="math display">\[E[y_{i2}|y_{i1},\mu,\Sigma]=\beta_{20.1}+\beta_{21.1}y_{i1}\]</span> <span class="math display">\[E[y_{i2}^2|y_{i1},\mu,\Sigma]=(\beta_{20.1}+\beta_{21.1}y_{i1})^2+\sigma_{22.1}\]</span> <span class="math display">\[E[y_{i2}y_{i2}|y_{i1},\mu,\Sigma]=(\beta_{20.1}+\beta_{21.1}y_{i1})y_{i1}.\]</span></p>
<p><strong>M step</strong>:</p>
<p>The M step consists in computing the maximum likelihood estimates as usual. Given <span class="math inline">\(s_1, s_2, s_{11}, s_{22}, \text{and } s_{12},\)</span> update <span class="math inline">\(\hat{\mu}\)</span> and <span class="math inline">\(\hat{\sigma}\)</span> with <span class="math display">\[\hat{\mu}_1=s_1/n\text{, }\hat{\mu}_2=s_2/n,\]</span> <span class="math display">\[\hat{\sigma}_1=s_{11}/n-\hat{\mu}_1^2\text{, }\hat{\sigma}_2=s_{22}/n-\hat{\mu}_2^2\text{, }\hat{\sigma}_{12}=s_{12}/n-\hat{\mu}_1\hat{\mu}_2\]</span></p>
<p>Note that <span class="math inline">\(s_1\)</span>, <span class="math inline">\(s_{11}\)</span>, <span class="math inline">\(\hat{\mu}_1\)</span> and <span class="math inline">\(\hat{\sigma}_1\)</span> are constant accross iterations since we do not have missing values on <span class="math inline">\(y_1\)</span>.</p>
<p><strong>(R3)</strong> Write two functions called Estep and Mstep that respectively perform the E step and the M step. The Estep function can take as an input <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\Sigma\)</span>. Then, you can compute <span class="math inline">\(\beta_{21.1}=\sigma_{12}/\sigma_{11}\)</span>, <span class="math inline">\(\beta_{20.1}=\mu_2-\beta_{21.1}\mu_1\)</span>, and <span class="math inline">\(\sigma_{22.1}=\sigma_{22}-\sigma^2_{12}/\sigma_{11}\)</span> and update the sufficient statistics <span class="math inline">\(s_{ij}\)</span>. The Mstep function consists in updating the update the <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\Sigma\)</span> given the <span class="math inline">\(s_{ij}\)</span>.</p>
<p><strong>(Q1)</strong> How could we initialize the algorithm ?</p>
<p><strong>(R4)</strong> Implement a function called initEM that returns initial values for <span class="math inline">\(\hat{\mu}\)</span> and <span class="math inline">\(\hat{\Sigma}\)</span>.</p>
<p><strong>(R5)</strong> Implement the EM algorithm over 15 iterations and plot the value of <span class="math inline">\(\left\|\mu-\hat{\mu}\right\|^2\)</span> over iterations. Comment your results briefly.</p>
<p><strong>(R6)</strong> Check that the EM estimator <span class="math inline">\(\mu\)</span> is equal to the maximum likelihood estimator.</p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="homework-pca.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="shiny-app.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/10-Missing.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
